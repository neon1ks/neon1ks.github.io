<!DOCTYPE HTML>
<html lang="ru">
<head>
<title>Перенос программ - cправочник по Си</title>
<meta charset="utf-8">
<link rel="stylesheet" href="../work/css.css">
</head><body>
<a href="../main.htm#28">Содержание</a> | <a href="2801.htm">&lt;&lt;&lt;</a> | <a href="2803.htm">&gt;&gt;&gt;</a><hr>
<h1>Перенос программ</h1>
<p class="tj">Очень часто (и это стало обыденной практикой) программы, написанные для одной машины, необходимо перенести на другой компьютер, оснащенный другим процессором или другой операционной системой, а зачастую и тем и другим одновременно. Этот процесс носит название <em>перенос</em>, или <em>перенесение (porting)</em>, и в одних случаях он может оказаться очень простым, а в других — предельно трудным. Это зависит от того, каким образом была первоначально написана программа. Поэтому, программа, которая легко поддается переносу, называется <em>переносимой, мобильной, или машинонезависимой</em><sup><a href="#11" id="1">[1]</a></sup><em>(portable)</em>. Если программа не относится к разряду переносимых, как правило, это объясняется тем, что она содержит большое количество элементов, <em>зависящих от типа машины</em>, — то есть, она имеет фрагменты кода, которые будут выполняться только в одной определенной операционной системе или на одном конкретном процессоре. Язык С позволяет создавать переносимый код, но для достижения этой цели необходимо проявлять особую тщательность и внимание к деталям. В данном разделе рассматриваются несколько конкретных проблем, возникающих при создании машинонезависимых программ и предлагается ряд решений таких проблем.
<h2>Использование #define</h2>
<p class="tj">Возможно, самый простой и эффективный способ сделать программы переносимыми состоит в том, чтобы представить каждое зависящее от типа системы или процессора "магическое число" макросом <kbd>#define</kbd>. Магическими эти числа были названы потому, что они представляют собой такие параметры системы, как размер буфера, используемого для обращения к диску, специальные команды управления экраном и клавиатурой, а также информацию о распределении памяти, иными словами, все то, что может измениться при переносе программы. Такие <kbd>#define</kbd>-определения не только делают все магические числа очевидными для программиста, выполняющего перенос, но к тому же упрощают выполнение всей работы. Ведь поскольку их значения необходимо будет изменить только однажды и в одном месте, следовательно, не придется "перетряхивать" всю программу.
<p class="tj">Например, рассмотрим оператор <kbd>fread()</kbd>, который по своей природе является непереносимым:
<pre>fread(buf, 128, 1, fp);</pre>
<p class="tj">В данном случае проблема заключается в том, что размер буфера (число 128) является жестко запрограммированным параметром функции <kbd>fread()</kbd>. Это значение может вполне подходить для одной операционной системе, но окажется меньше оптимальной величины для другой. А вот более удачный способ кодирования этой же функции:
<pre>#define BUF_SIZE 128
fread(buf, BUF_SIZE, 1, fp);</pre>
<p class="tj">В последнем варианте при переносе на другую систему понадобится всего лишь изменить определение <kbd>#define</kbd> — и все ссылки на <kbd>BUF_SIZE</kbd> будут исправлены автоматически. Это не только облегчает процесс внесения изменений, но и вдобавок уберегает от массы ошибок при редактировании. Помните, что в реальной программе может присутствовать бездна ссылок на <kbd>BUF_SIZE</kbd>, поэтому переносимость программы возрастает многократно.
<h2>Зависимость от операционной системы</h2>
<p class="tj">Код практически всех коммерческих программ адаптирован для конкретной операционной системы, под управлением которой предполагается их работа. К примеру, программа, написанная для Windows 2000, может использовать многопотоковую многозадачность, тогда как программа, написанная для 16-разрядной Windows 3.1, не может. Дело в том, что определенная привязка к особенностям конкретной операционной системы совершенно необходима, чтобы получить по-настоящему хорошие, быстродействующие и по-коммерчески жизнеспособные программы. Однако с другой стороны, зависимость от операционной системы усложняет процесс переноса программ.
<p class="tj">Хотя и не существует жестких правил, следуя которым можно было бы минимизировать зависимость разрабатываемых программ от типа операционной системы, позвольте предложить маленький совет. Отделяйте в разрабатываемой программе те части, которые относятся непосредственно к приложению от тех фрагментов, которые осуществляют взаимодействие с операционной системой. Тогда при переносе программы в новую среду потребуется изменить только модули интерфейса.
<h2>Различия в размерах данных</h2>
<p class="tj">Если вы хотите написать переносимый код, никогда не следует полагаться на ожидаемые размеры данных. Например, надо всегда учитывать отличия между 16-разрядной и 32-разрядной средами. Размер слова в 16-разрядном процессоре равен 16 битам, а в 32-разрядном процессоре — 32 битам. Поскольку размер слова часто совпадает с размером данных типа <kbd>int</kbd>, то код, созданный в предположении, что переменные типа <kbd>int</kbd> являются, к примеру, 16-разрядными, не будет корректно работать после переноса его в 32-разрядную среду. Чтобы избежать жесткой привязки к размеру, там, где программе понадобятся сведения о количестве байтов, составляющих какую-нибудь величину, обязательно используйте оператор <kbd>sizeof</kbd>. Например, следующее выражение заносит значение типа <kbd>int</kbd> в дисковый файл и будет работать в любой среде:
<pre>fwrite(&i, sizof(int), 1, stream);</pre>
<p><img src="../work/sup.bmp" alt="----------">
<blockquote>
<p class="tj"><sup><a href="#1" id="11">[1]</a></sup>Термины <em>портабильность</em> и <em>портабильный</em> к настоящему времени несколько утратили свою первоначальную популярность.
</blockquote>
<p>
</p>
<hr><a href="../main.htm#28">Содержание</a> | <a href="2801.htm">&lt;&lt;&lt;</a> | <a href="2803.htm">&gt;&gt;&gt;</a>
</body>
</html>
